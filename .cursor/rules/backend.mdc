---
description: 
globs: **/api/src/**/*.ts,**/api/src/**/*.js
alwaysApply: false
---
# Backend Rules for Training Platform

Project: `api/` â€“ Express v5 + TypeScript + Prisma + SQLite

---

## ğŸ“‚ Directory Structure

Naming Convention: use kebab-case for files and directories (eg. `course-service.ts`, `user-controller.ts`).

`api/`
`â”œâ”€ prisma/` # schema.prisma + migrations + dev.db (prod uses a different path)
`â”œâ”€ src/`
`â”‚ â”œâ”€ dto/` # obiekty DTO (course-dto.ts, enrollment-dto.ts)
`â”‚ â”œâ”€ entities/` # encje domenowe (course-entity.ts, ...)
`â”‚ â”œâ”€ exceptions/` # wyjÄ…tki HTTP (bad-request-exception.ts, ...)
`â”‚ â”œâ”€ repositories/` # dostÄ™p do bazy (course-repository.ts, ...)
`â”‚ â”œâ”€ services/` # business logic, Prisma integration (course-service.ts, ...)
`â”‚ â”œâ”€ controllers/` # HTTP logic â†’ calls to services (user-controller.ts, ...)
`â”‚ â”œâ”€ routes/` # endpoint definitions, auth middleware (course-route.ts, ...)
`â”‚ â”œâ”€ middlewares/` # error handler, auth guard, validators (auth-middleware.ts, ...)
`â”‚ â”œâ”€ utils/` # helpers: env loader, logger, asyncHandler (jwt.utils.ts, logger.ts, ...)
`â”‚ â”œâ”€ index.ts` # app setup (express.json(), cors, routes)
`â”‚ â””â”€ server.ts`
`â”œâ”€ .env`               # DATABASE_URL, JWT_SECRET, NODE_ENV
`â””â”€ tsconfig.json`

---

## âš™ï¸ Scripts (package.json)
- **dev**: `bun run dev` â†’ `ts-node-dev --respawn src/index.ts`  
- **build**: `bun run build` â†’ `tsc --project tsconfig.json`  
- **start**: `bun run start` â†’ `node dist/index.js`  
- **Prisma**:  
  - `bunx prisma migrate` â†’ create & apply migrations  
  - `bunx prisma generate` â†’ generate Prisma client  
  - `bunx prisma studio` â†’ launch schema browser

---

## ğŸ” Authorization & Security
- **JWT**  
  - Use a 32+ character `JWT_SECRET` from `.env`.  
  - Access tokens expire in ~2h; no refresh token for MVP.  
  - Clients send tokens in `Authorization: Bearer <token>`.  
- **Password Hashing**  
  - Use `bcryptjs` with default salt rounds; hash before persisting.  
- **Role Checks**  
  - Middleware verifies `req.user.role` (ADMIN/TRAINER/PARTICIPANT).  
- **Headers**  
  - Use `helmet` for basic security (CORS, HSTS, etc.).

---

## ğŸ›  Errors & Validation
- Validate inputs (body, params) with Zod or Joi at the start of handlers.  
- Centralize error handling in `middlewares/errorHandler.ts`.  
- Use proper HTTP status codes:  
  - 400 Bad Request â€“ validation errors  
  - 401 Unauthorized â€“ missing/invalid token  
  - 403 Forbidden â€“ insufficient permissions  
  - 404 Not Found â€“ missing resources  
  - 500 Internal Server Error â€“ unexpected failures

---

## ğŸ—„ Prisma & Database
- Define `User`, `Course`, `Enrollment` with relations in `schema.prisma`.  
- Run `prisma migrate dev --name <description>` for every schema change.  
- Import `PrismaClient` from a single file (e.g., `utils/prisma.ts`).  
- Use transactions for multi-step operations (e.g., enrollments).  
- On shutdown (SIGINT/SIGTERM), call `prisma.$disconnect()` in `server.ts`.

---

## ğŸ“‹ Logging & Monitoring
- Integrate a logger (`winston` or `pino`):  
  - `info` level for requests, `error` for exceptions.  
  - Log method, URL, userId, and response time.  
- Health-check endpoint: `GET /health` returns `{ status: 'ok' }`.

---

## ğŸ§ª Testing
- Use Jest + Supertest.  
- For unit tests, mock PrismaClient.  
- For integration tests, use an in-memory SQLite or separate dev.db.  
- Aim for â‰¥80% coverage on auth, course CRUD, and enrollments.

---

## ğŸ“¦ Build & Deployment
- **Docker**:  
  - Dev uses `ts-node-dev`; Prod uses `build` â†’ `start`.  
  - Expose port `4000`; include a health-check in `docker-compose.yml`.  
- **Environment**:  
  - Do not commit `.env`; load via `dotenv` in `index.ts`.

## Naming Conventions

All backend source files and folders must use **kebab-case**.  
Suffix conventions (with hyphens) to reveal module purpose:
- Controllers: `-controller.ts`
- Services: `-service.ts`
- Repositories: `-repository.ts`
- Middleware: `-middleware.ts`
- DTO definitions: `-dto.ts`
- Utility helpers: `-util.ts`